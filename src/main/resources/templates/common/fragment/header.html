<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      th:fragment="HeaderFragment">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>KingCherry</title>
  <style>
    body{
      margin:0;
      color:#6a6f8c;
      background:#c8c8c8;
      font:600 16px/18px 'jua',sans-serif;
    }
    *,:after,:before{box-sizing:border-box}
    .clearfix:after,.clearfix:before{content:'';display:table}
    .clearfix:after{clear:both;display:block}
    a{color:inherit;text-decoration:none}

    .login-wrap{
      width:100%;
      margin:auto;
      max-width:525px;
      min-height:670px;
      position:relative;
    }
    .login-html{
      width:100%;
      height:100%;
      position:absolute;
      padding:90px 70px 50px 70px;
    }
    .login-html .sign-in-htm,
    .login-html .sign-up-htm{
      top:0;
      left:0;
      right:0;
      bottom:0;
      position:absolute;
      transform:rotateY(180deg);
      backface-visibility:hidden;
      transition:all .4s linear;
    }
    .login-html .sign-in,
    .login-html .sign-up,
    .login-form .group .check{
      display:none;
    }
    .login-html .tab,
    .login-form .group .label,
    .login-form .group .button{
      text-transform:uppercase;
    }
    .login-html .tab{
      font-size:22px;
      margin-right:15px;
      padding-bottom:5px;
      margin:0 15px 10px 0;
      display:inline-block;
      border-bottom:2px solid transparent;
    }
    .login-html .sign-in:checked + .tab,
    .login-html .sign-up:checked + .tab{
      color:#f85a40;
      border-color:#1161ee;
    }
    .login-form{
      min-height:345px;
      position:relative;
      perspective:1000px;
      transform-style:preserve-3d;
      margin-top:40px;
    }
    .login-form .group{
      margin-bottom:15px;
    }
    .login-form .group .label,
    .login-form .group .input,
    .login-form .group .button{
      width:100%;
      display:block;
    }
    .login-form .group .input,
    .login-form .group .button{
      padding:15px 20px;
      border-radius:25px;
      border: 1px solid #f85a40
    }
    .login-form .group input[data-type="password"]{
      text-security:circle;
      -webkit-text-security:circle;
    }
    .login-form .group .label{
      color:#aaa;
      font-size:12px;
    }

    .login-form .group .button{
      background:#f85a40;
      color: #fff
    }
    .login-form .group label .icon{
      width:15px;
      height:15px;
      border-radius:2px;
      position:relative;
      display:inline-block;
      border: 1px solid black;
    }
    .login-form .group label .icon:before,
    .login-form .group label .icon:after{
      content:'';
      width:10px;
      height:2px;
      background:#fff;
      position:absolute;
      transition:all .2s ease-in-out 0s;
    }
    .login-form .group label .icon:before{
      left:3px;
      width:5px;
      bottom:6px;
      transform:scale(0) rotate(0);
    }
    .login-form .group label .icon:after{
      top:6px;
      right:0;
      transform:scale(0) rotate(0);
    }
    .login-form .group .check:checked + label{
      color:#f85a40;
    }
    .login-form .group .check:checked + label .icon{
      background:#1161ee;
    }
    .login-form .group .check:checked + label .icon:before{
      transform:scale(1) rotate(45deg);
    }
    .login-form .group .check:checked + label .icon:after{
      transform:scale(1) rotate(-45deg);
    }
    .login-html .sign-in:checked + .tab + .sign-up + .tab + .login-form .sign-in-htm{
      transform:rotate(0);
    }
    .login-html .sign-up:checked + .tab + .login-form .sign-up-htm{
      transform:rotate(0);
    }

    .hr{
      height:2px;
      margin:60px 0 50px 0;
    }
    .foot-lnk{
      text-align:center;
    }
  </style>
</head>
<!-- Navigation-->
<header id="header" class="header d-flex align-items-center">
  <div class="container-fluid container-xl d-flex align-items-center justify-content-between">
    <a href="/" class="logo d-flex align-items-center">
      <!-- Uncomment the line below if you also wish to use an image logo -->
      <!-- <img src="assets/img/logo.png" alt=""> -->
      <h1 style="font-family: 'jua', sans-serif"><img th:src="@{/assets/img/cherry/cherry-svgrepo-com.svg}"/><span>킹</span>체리</h1>
    </a>
    <nav id="navbar" class="navbar">
      <ul id="nav">
        <li id="intro"><a href="#introduce">소개</a></li>
        <li id="product"><a href="#product">상품</a></li>
   <!--     <li id="notice"><a href="#notice">공지사항</a></li>
        <li id="review"><a href="#review">리뷰</a></li>-->
        <li></li>
        <li></li>
        <li id="anon" hidden="hidden">
          <a href="#" id="inner-profile" class="justify-content-start">
            <i class="fas fa-sign-in-alt"></i><span style="margin-left: 5px" class="login-modal">로그인</span>
          </a>
        </li>
        <li id="auth" class="dropdown" hidden="hidden">
          <a href="#" class=""><span id="userName"></span>
          <i class="bi dropdown-indicator bi-chevron-down"></i></a>
          <ul style="border: 1px solid var(--color-secondary)">
            <li id="my-info"><a href="#">내 정보 조회</a></li>
            <li id="my-page"><a href="#">내 정보 수정</a></li>
            <li id="order-history"><a href="#">주문 내역</a></li>
            <li id="logout"><a href="#">로그아웃</a></li>
          </ul>
        </li>
        <li id="cart"><a href="#"><i class="fas fa-shopping-cart"></i></a></li>
        <!--<li><a href="https://www.instagram.com/kk_ing_cherry/?next=%2F">인스타그램<i class="bi bi-instagram d-flex ms-4"></i></a></li>-->
      </ul>
    </nav>

    <i class="mobile-nav-toggle mobile-nav-show bi bi-list"></i>
    <i class="mobile-nav-toggle mobile-nav-hide d-none bi bi-x"></i>
  </div>
</header>

<ul class="nav">
  <li>
    <div class="modal fade" id="loginModal" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-body">
              <div class="login-wrap">
                <div class="modal-header">
                  <button id="modal-close" type="button" class="close" data-dismiss="modal" aria-label="Close">×</button>
                </div>
                <div class="login-html">
                  <input id="tab-1" type="radio" name="tab" class="sign-in" checked><label for="tab-1" class="tab">회원</label>
                  <input id="tab-2" type="radio" name="tab" class="sign-up"><label for="tab-2" class="tab">비회원</label>
                  <div class="login-form">
                    <div class="sign-in-htm">
                      <form id="login-data" class="align-items-center">
                        <div class="group">
                          <label for="email-login" class="label">이메일</label>
                          <input id="email-login" name="userEmail" type="text" class="input">
                        </div>
                        <div class="group">
                          <label for="password-login" class="label">비밀번호</label>
                          <input id="password-login" name="password" type="password" class="input" data-type="password">
                        </div>
                        <div class="group">
                          <input id="check" type="checkbox" class="check" checked>
                          <label for="check"><span class="icon"></span> 아이디 기억하기</label>
                        </div>
                        <div class="group">
                          <input id="login-btn" type="button" class="button" value="로그인">
                        </div>
                        <div id="error" class="group" hidden="hidden"><span style="color:red">이메일, 비밀번호를 확인해 주세요.</span></div>
                      </form>
                      <div class="hr"></div>
                      <div class="foot-lnk">
                        <span id="register">회원 가입</span> <!--/ <span id="findAccount">계정 찾기</span>-->
                      </div>
                    </div>
                    <form id="-data" class="align-items-center">
                      <div class="sign-up-htm">
                        <div class="group">
                          <label for="login-orderNo" class="label">주문번호</label>
                          <input id="login-orderNo" type="text" class="input">
                        </div>
                        <div class="group">
                          <label for="login-phone" class="label">전화번호</label>
                          <input type="text" id="login-phone" name="phoneNumber" class="input"
                                 value="" style="text-align:center;" maxlength="13"
                                 placeholder="000-0000-0000"
                                 pattern="[0-9]{3}-[0-9]{4}-[0-9]{4}"/>
                        </div>
                        <div class="group">
                          <input id="search" type="submit" class="button" value="주문조회">
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
          </div>
        </div>
      </div>
    </div>
  </li>
</ul>

<script th:inline="javascript">

  /*function preventRightClick(event) {
    event.preventDefault();
  }
  // 우클릭 이벤트를 감지하여 막음
  document.addEventListener('contextmenu', preventRightClick);*/

  function isEmpty(value){
    return value === "" || value === null || value === undefined || (typeof value === "object" && !Object.keys(value).length);
  }

  function auth() {
    $('#auth').attr('hidden', false);
    $('#anon').attr('hidden', true);
  }

  function anno() {
    $('#anon').attr('hidden', false);
    $('#auth').attr('hidden', true);
  }

  let accessToken;
  let role;

  $(document).ready(function () {
    const kci = window.localStorage.getItem("kci")
    if(!isEmpty(kci)) {
      $('#email-login').val(kci);
    }

    if(isEmpty(accessToken)) {
        $.post({
          url: "/api/v1/auth/reissue",
          // headers:{'Authorization': "Bearer "+accessToken}
        }).done((data) => {
          accessToken = data.accessToken;
          role = data.role
          if(role === 'ROLE_ADMIN') {
            $('#nav').append(`<li id="manage"><a href="#">주문관리</a></li>`)
          }
          setName();
        }).fail(() => {
          anno();
        })
    } else {
      if(role === 'ROLE_ADMIN') {
        $('#nav').append(`<li id="manage"><a href="#">주문관리</a></li>`)
      }
      setName();
    }
  })

  function setName() {
    $.get({
      url: "/api/v1/member/findByEmail",
      headers:{'Authorization': "Bearer "+accessToken}
    }).done((data) => {
      $('#userName').text(data.user.name);
      auth();
    }).fail(() => {
      anno();
    })
  }

  function active() {
    const path = window.location.pathname

    $('#intro').removeClass("active");
    $('#product').removeClass("active");
    $('#notice').removeClass("active");
    $('#review').removeClass("active");
    $('#cart').removeClass("active");

    if(path.startsWith("/product")) {
      $('#product').addClass("active");
    } else if(path.startsWith("/notice")) {
      $('#notice').addClass("active");
    } else if(path.startsWith("/review")) {
      $('#review').addClass("active");
    } else if(path.startsWith("/cart")) {
      $('#cart').addClass("active");
    } else {
      $('#intro').addClass("active");
    }
  }

  $('#intro').on('click', ()=> {
    location.href="/"
  })

  $('#product').on('click', ()=> {
    location.href="/product/list"
  })

  $(document).on('click', '.login-modal',() => {
      $('#loginModal').modal('show')
  })

  $('#signUp').on('click', () => {
    $('#login-container').addClass("right-panel-active");
  });

  $('#signIn').on('click', () => {
    $('#login-container').removeClass("right-panel-active");
  });

  $('#modal-close').on('click', () => {
    $('form').each(function () {
      this.reset();
    })
    $('#loginModal').modal('hide');
  })

  $("#notice #review").on('click', () => {
    alert("준비중 입니다.")
  })

  $('#register').on('click', () => {
    location.href = "/member/register"
  })

  $('#login-btn').on('click', () => {
    $.post({
      url: "/api/v1/auth/login",
      contentType: 'application/json; charset=utf-8',
      xhrFields: { withCredentials: true },
      data: JSON.stringify({
        "user" : {
          "email" : $('#email-login').val(),
          "password" : $('#password-login').val()
        }
      })
    }).done(() => {

      if($('#check').is(':checked')) {
        window.localStorage.setItem("kci", $('#email-login').val());
      } else {
        window.localStorage.removeItem("kci");
      }
      window.location.href = window.location.pathname;
    }).fail((data) => {
      if(data.status === 500) {
        $('#error').attr('hidden', false);
      }
    })
  })

  $('#logout').on('click', () => {
    $.ajax({
      url: "/api/v1/auth/logout",
      method: "DELETE",
      headers:{'Authorization': "Bearer "+accessToken},
      xhrFields: { withCredentials: true },
      contentType: 'application/json; charset=utf-8',
      data: JSON.stringify({
        "accessToken" : accessToken
      })
    }).done(() => {
      window.location.href = "/"
    })
  })

  $("#cart").on('click', () => {
    window.location.href = "/cart/list"
  })

  $('#my-info').on('click', () => {
    if(!checkUrl()) return;
    $.get({
      url:"/member/info",
      headers:{'Authorization': "Bearer "+accessToken}
    }).done((data) => {
      $('#content-body').html(data)
    }).fail(() => {
      window.location.href = '/'
    })
  })

  $('#my-page').on('click', () => {
    if(!checkUrl()) return;
    $.get({
      url:"/member/update",
      headers:{'Authorization': "Bearer "+accessToken}
    }).done((data) => {
      $('#content-body').html(data)
    }).fail(() => {
        window.location.href = '/'
    })
  })

  $('#order-history').on('click', () => {
    if(!checkUrl()) return;
    $.get({
      url: "/order/history",
      headers: {'Authorization': "Bearer " + accessToken}
    }).done((data) => {
      $('#content-body').html(data)
    }).fail(() => {
      window.location.href = '/'
    })
  })

  document.addEventListener("DOMContentLoaded", function() {
    document.getElementById("login-phone").addEventListener("keyup", function(event) {
      inputPhoneNumber(event);
    });
  });

  function inputPhoneNumber(event) {
    const phone = event.target;
    if( event.keyCode !== 8 ) {
      const regExp = new RegExp( /^[0-1]{3}-^[0-9]{4}-^[0-9]{4}/g );
      if( phone.value.replace( regExp, "").length !== 0 ) {
        if( checkPhoneNumber( phone.value ) === true ) {
          let number = phone.value.replace( /[^0-9]/g, "" );
          let tel = "";
          let seoul = 0;
          if( number.substring( 0, 2 ).indexOf( "02" ) === 0 ) {
            seoul = 1;
            phone.setAttribute("maxlength", "12");
            console.log( phone );
          } else {
            phone.setAttribute("maxlength", "13");
          }
          if( number.length < ( 4 - seoul) ) {
            return number;
          } else if( number.length < ( 7 - seoul ) ) {
            tel += number.substr( 0, (3 - seoul ) );
            tel += "-";
            tel += number.substr( 3 - seoul );
          } else if(number.length < ( 11 - seoul ) ) {
            tel += number.substr( 0, ( 3 - seoul ) );
            tel += "-";
            tel += number.substr( ( 3 - seoul ), 3 );
            tel += "-";
            tel += number.substr( 6 - seoul );
          } else {
            tel += number.substr( 0, ( 3 - seoul ) );
            tel += "-";
            tel += number.substr( ( 3 - seoul), 4 );
            tel += "-";
            tel += number.substr( 7 - seoul );
          }
          phone.value = tel;
        } else {
          const regExp = new RegExp( /[^0-9|^-]*$/ );
          phone.value = phone.value.replace(regExp, "");
        }
      }
    }
  }

  function checkPhoneNumber( number ) {
    const regExp = new RegExp( /^[0-9|-]*$/ );
    if( regExp.test( number ) === true ) { return true; }
    else { return false; }
  }

  $('#search').on('click', () => {
    if(!checkUrl()) return;
    const orderNo = $('#login-orderNo').val()
    const phone = $('#login-phone').val()
    if(isEmpty(orderNo)) {
      alert("주문 번호 입력해 주세요.")
      $('#login-orderNo').focus();
      return;
    }

    if(isEmpty(phone)) {
      alert("휴대폰 번호를 입력해 주세요.")
      $('#login-phone').focus();
      return;
    }
    const regExp = new RegExp( /[0-1]{3}-[0-9]{4}-[0-9]{4}/g );
    if(!regExp.test(phone)) {
      alert("휴대폰 번호 형식을 확인해 주세요.")
      $('#login-phone').focus();
      return;
    }

    $.post({
      url: "/api/v1/order/anon/history",
      contentType: 'application/json; charset=utf-8',
      data: JSON.stringify({
        "orderNo" : orderNo,
        "phoneNumber": phone
      })
    }).done((data) => {
      if(data.code === "400") {
        alert(data.msg);
        return;
      }
      if(data.code === "200") {
        $.post({
          url: "/order/history/anon",
          contentType: 'application/json; charset=utf-8',
          data: JSON.stringify({
            "orderId" : orderNo,
            "phoneNumber": phone
          })
        }).done((data) => {
          $('form').each(function () {
            this.reset();
          })
          $('#loginModal').modal('hide');
          $('#content-body').html(data);
        })
      }
    })
  })

  $(document).on('click', '#manage', () => {
    if(!checkUrl()) return;
    $.get({
      url: "/order/history/admin",
      headers: {'Authorization': "Bearer " + accessToken}
    }).done((data) => {
      $('#content-body').html(data)
    }).fail(() => {
      window.location.href = '/'
    })
  })

  function checkUrl() {
    const pathName = window.location.pathname;
    if(pathName.startsWith("/serverAuth") || pathName.startsWith("/cancelAuth")) {
      if(confirm("현재 페이지에서 접근할 수 없습니다. 메인페에지로 이동하시겠습니까?")) {
        window.location.href = "/"
      } else {
        return false;
      }
    }
    return true;
  }
</script>